name: Build Peerstack Academy Windows

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

jobs:
  build-windows:
    runs-on: windows-2022
    timeout-minutes: 180
    
    steps:
      - name: Export GitHub Actions cache
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Setup LLVM Path
        run: |
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0
          targets: x86_64-pc-windows-msvc
      
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: windows-2022
      
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true
      
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vcpkgGitCommitId: '120deac3062162151622ca4860575a33844ba10b'
          doNotCache: false
          
      - name: Install vcpkg dependencies
        run: |
          cd C:\vcpkg
          .\vcpkg.exe install libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static --x-install-root="$env:VCPKG_ROOT/installed"
      
      - name: Build RustDesk
        run: python build.py --flutter --hwcodec
      
      - name: Prepare artifact
        run: |
          mkdir output
          Copy-Item -Path "flutter\build\windows\x64\runner\Release\*" -Destination "output\" -Recurse
      
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: Peerstack-Academy-Windows
          path: output/